<html>

<head>
	
	<title>Perun situation map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" /> -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>

</head>
<body>



<div id="mapid" style="padding:20px; height:800px"></div>

<script src="milsymbol.js"></script>
<script src="situation.js"></script>
<script type="text/javascript">

	var iconSize = {
        "Team/Crew": 5,
        "Squad": 10,
        "Section": 15,
        "Platoon/detachment": 20,
        "Company/battery/troop": 25,
        "Battalion/squadron": 30,
        "Regiment/group": 35,
        "Brigade": 40,
        "Division": 45,
        "Corps/MEF": 50,
        "Army": 55,
        "Army Group/front": 60,
        "Region/Theater": 65,
        "Command": 70
      };
	  
	// function to popup coordinates (for dev)
	function onMapClick(e) {
		var paragraph = document.getElementById("output");
		paragraph.appendChild(document.createElement("br"));
		paragraph.appendChild(document.createTextNode("[" + e.latlng.lat + ", " + e.latlng.lng + "],"));
		}

	// Create the map
	var map = L.map('mapid').setView([53.58425130374624, 10.523014068603517], 10);
	
	<!-- var mapurl = 'https://api.mapbox.com/styles/v1/tomwhalstead/cjh8ka1zw1rjx2sqrwg8223sv/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoidG9td2hhbHN0ZWFkIiwiYSI6ImNqaDhrM3diNjAyc2wzOWw3YTFrbTExcGYifQ.8_2y6B32ehJIsvUTD85ZNw'; -->
	var mapurl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
	
	L.tileLayer(mapurl, {
		maxZoom: 18,}).addTo(map);
	
	// bind the onclick event
	map.on('click', onMapClick)
	
	// create a polygon
	<!-- L.polygon([ -->
		<!-- [53.50030019180739, 10.479927062988283], -->
		<!-- [53.506426191705565, 10.501556396484377], -->
		<!-- [53.52030851420592, 10.543785095214846], -->
		<!-- [53.52112497978768, 10.556488037109377], -->
		<!-- [53.52786022045556, 10.568161010742188], -->
		<!-- [53.54928340748793, 10.56610107421875], -->
		<!-- [53.585576048991676, 10.63957214355469], -->
		<!-- [53.59433870242693, 10.644721984863283], -->
		<!-- [53.610636478849145, 10.619316101074219], -->
		<!-- [53.64138139745019, 10.583953857421877], -->
		<!-- [53.52969691841282, 10.49468994140625], -->
		<!-- [53.505201062547066, 10.468597412109377], -->
		<!-- ],{color: 'red'}).addTo(map).bindPopup("Captured by 18. Motor Rifle Regiment"); -->
	
	<!-- L.polygon([ -->
		<!-- [53.59433870242693, 10.644721984863283], -->
		<!-- [53.610636478849145, 10.619316101074219], -->
		<!-- [53.64138139745019, 10.583953857421877], -->
		<!-- [53.667425777235316, 10.6512451171875], -->
		<!-- [53.657050647869, 10.658798217773438], -->
		<!-- [53.649623742062396, 10.675964355468752], -->
		<!-- [53.63415530130101, 10.674247741699219], -->
		<!-- [53.62601173793108, 10.669269561767578], -->
		<!-- ],{color: 'red'}).addTo(map).bindPopup("Captured by 21. Motor Rifle Regiment"); -->
	
	// create a line
	var frontline = L.polyline([
		[53.9560855309879, 10.902557373046875],
		[53.928602727199326, 10.897064208984375],
		[53.92051610357607, 10.909423828125002],
		[53.918089811001245, 10.946502685546877],
		[53.902720016840476, 10.957489013671877],
		[53.89948354993688, 10.917663574218752],
		[53.89786522246521, 10.902557373046875],
		[53.91323680284411, 10.908050537109375],
		[53.918898590859456, 10.884704589843752],
		[53.91323680284411, 10.861358642578127],
		[53.89786522246521, 10.835266113281252],
		[53.887344565988755, 10.814666748046877],
		[53.872773130564575, 10.781707763671877],
		[53.8662953069172, 10.761108398437502],
		[53.84766597522362, 10.747375488281252],
		[53.833891138375634, 10.752868652343752],
		[53.820111769559674, 10.756988525390625],
		[53.79740645735382, 10.763854980468752],
		[53.77874646437006, 10.763854980468752],
		[53.76007817077558, 10.754241943359375],
		[53.7438381234801, 10.758361816406252],
		[53.74140157486069, 10.79132080078125],
		[53.72840426276383, 10.811920166015627],
		[53.71784098729247, 10.821533203125002],
		[53.70646218454777, 10.846252441406252],
		[53.67962854209753, 10.953369140625],
		[53.655219477553516, 10.9368896484375],
		[53.63975308945901, 10.953369140625],
		[53.62102302920731, 10.928649902343752],
		[53.6104327954549, 10.917663574218752],
		[53.593319882593995, 10.917663574218752],
		[53.570491879287, 10.909423828125002],
		[53.56722972951221, 10.880584716796877],
		[53.56478295204427, 10.848999023437502],
		[53.5753846321476, 10.835266113281252],
		[53.56559856026117, 10.820159912109375],
		[53.55825752009741, 10.832519531250002],
		[53.54438763473505, 10.829772949218752],
		[53.52071674896369, 10.817413330078125],
		[53.51418452077113, 10.799560546875],
		[53.50030019180739, 10.787200927734377],
		[53.47578733864619, 10.713043212890627],
		[53.474969999548556, 10.699310302734377],
		[53.45453140531, 10.692443847656252],
		[53.45943756538679, 10.671844482421875],
		[53.45861991140519, 10.653991699218752],
		[53.444717384524694, 10.634765625],
		[53.4357192066942, 10.62652587890625],
		[53.415261714992205, 10.615539550781252],
		[53.36038708103963, 10.611419677734375],
		[53.370220573956786, 10.70892333984375],
		[53.33661343554715, 10.754241943359375],
		[53.306262292435996, 10.850372314453127],
		[53.33825342294645, 10.93963623046875],
		[53.32185071096412, 10.984954833984375],
		[53.29230993420696, 11.0137939453125],
		[53.202742353507254, 11.114044189453127],
		[53.173119202640635, 11.197814941406252],
		[53.15747651067802, 11.185455322265627],
		[53.13111803493987, 11.201934814453125],
		[53.13276591360896, 11.24725341796875],
		[53.102269927206926, 11.284332275390625],
		[53.077527569052094, 11.288452148437502],
		[53.05607268392864, 11.3323974609375],
		[53.04616682440388, 11.369476318359375],
		[53.05854879304512, 11.391448974609377],
		[53.07422751310222, 11.432647705078125],
		[53.071752305151335, 11.466979980468752],
		[53.05112003878514, 11.497192382812502],
		[53.04203871089796, 11.535644531250002],
		[53.03625868781451, 11.5576171875],
		[53.019740066071975, 11.572723388671877],
		[53.021805239768454, 11.579589843750002],
		[52.99701663038586, 11.552810668945314],
		[53.00032260090551, 11.528091430664062],
		[53.001562274591464, 11.511611938476564],
		[52.986683840958655, 11.501998901367188],
		[52.96394300154682, 11.497192382812502],
		[52.950706460441324, 11.495132446289064],
		[52.94243156463617, 11.501998901367188],
		[52.94036259335616, 11.473846435546877],
		[52.92960234781301, 11.449127197265625],
		[52.87410326334818, 11.32415771484375],
		[52.87741863698718, 11.277465820312502],
		[52.8873632373409, 11.217041015625002],
		[52.89233468225212, 11.131896972656252],
		[52.89233468225212, 11.071472167968752],
		[52.89730555702354, 11.03302001953125],
		[52.884048623975254, 10.980834960937502],
		[52.8525471567007, 10.777587890625002],
		[52.8210228115302, 10.736389160156252],
		[52.78947558139889, 10.774841308593752],
		[52.72132197262256, 10.821533203125002],
		[52.6613918338043, 10.87371826171875],
		[52.62972886718355, 10.901184082031252],
		[52.61805778461654, 10.917663574218752],
		[52.61639023304539, 10.986328125000002],
		[52.58469468354708, 10.95611572265625],
		[52.54462541375285, 10.964355468750002],
		[52.51287794429001, 10.994567871093752],
		[52.447640168883865, 10.9368896484375],
		[52.40241887397332, 11.000061035156252],
		[52.38398208257353, 11.041259765625002],
		[52.3336607715546, 11.02203369140625],
		[52.28664250209102, 11.046752929687502],
		[52.234528294213646, 11.082458496093752],
		[52.210972768075365, 11.057739257812502],
		[52.14697334064471, 11.02752685546875],
		[52.10650519075632, 10.989074707031252],
		[52.07444183716456, 10.931396484375002],
		[52.054179425297185, 10.923156738281252],
		[52.057557132353644, 10.854492187500002],
		[52.04742324502936, 10.78582763671875],
		[52.042355439413214, 10.7061767578125],
		[52.02714857444256, 10.662231445312502],
		[52.00855538139683, 10.63201904296875],
		[52.00855538139683, 10.5633544921875],
		[51.94765088987202, 10.610046386718752],
		[51.95272942685293, 10.63201904296875],
		[51.878186564984, 10.659484863281252],
		[51.798424491278745, 10.599060058593752],
		[51.7508394806285, 10.618286132812502],
		[51.68447672270844, 10.667724609375002],
		[51.66574141105715, 10.681457519531252],
		[51.63847621195153, 10.696563720703127],
		[51.62483746174322, 10.664978027343752],
		[51.60522457335248, 10.647125244140627],
		[51.58304327584647, 10.636138916015627],
		[51.57621608189103, 10.660858154296877],
		[51.55743600972587, 10.658111572265627],
		[51.55658218576253, 10.633392333984377],
		[51.57621608189103, 10.621032714843752],
		[51.57621608189103, 10.604553222656252],
		[51.5540206177, 10.564727783203127],
		[51.55145890537643, 10.524902343750002],
		[51.55231282551346, 10.505676269531252],
		[51.56853426269097, 10.493316650390627],
		[51.58218993269148, 10.445251464843752],
		[51.58560320916062, 10.390319824218752],
		[51.58560320916062, 10.373840332031252],
		[51.57962980707405, 10.368347167968752],
		[51.565119704124186, 10.375213623046877],
		[51.55572834577052, 10.366973876953127],
		[51.5429188223739, 10.364227294921877],
		[51.53096001302977, 10.349121093750002],
		[51.52668824818813, 10.34088134765625],
		[51.519852590742715, 10.331268310546877],
		[51.517288954651875, 10.323028564453127],
		[51.50703296721856, 10.291442871093752],
		[51.50019435946635, 10.295562744140627],
		[51.49335472541077, 10.272216796875002],
		[51.48052764515145, 10.239257812500002],
		[51.47967237816338, 10.225524902343752],
		[51.48052764515145, 10.211791992187502],
		[51.468552447762384, 10.188446044921877],
		[51.444592621121764, 10.159606933593752],
		[51.434320273775626, 10.130767822265627],
		[51.430895644580175, 10.101928710937502],
		[51.408629296986234, 10.015411376953127],
		[51.40177593070748, 9.976959228515627],
		[51.38806611676009, 9.948120117187502],
		[51.37520943448466, 9.928894042968752],
		[51.35634643388431, 9.920654296875002],
		[51.342623007528275, 9.937133789062502],
		[51.317738820339734, 9.946746826171877],
		[51.316880504045876, 9.944000244140627],
		[51.293699893323726, 9.9591064453125],
		[51.28081671677971, 9.985198974609377],
		[51.27566243415853, 10.051116943359377],
		[51.26277419739382, 10.053863525390627],
		[51.21118509795345, 10.103302001953127],
		[51.21806698712828, 10.121154785156252],
		[51.19827878319755, 10.188446044921877],
		[51.18795112740308, 10.239257812500002],
		[51.17503830237217, 10.222778320312502],
		[51.1190409225206, 10.213165283203127],
		[51.11128208389564, 10.199432373046877],
		[51.13455469147683, 10.18363952636719],
		[51.14575583962207, 10.177459716796877],
		[51.15006324988587, 10.162353515625002],
		[51.14360198373563, 10.144500732421877],
		[51.14101722400494, 10.123901367187502],
		[51.132831196692806, 10.128021240234377],
		[51.12162691254955, 10.145874023437502],
		[51.11516166606164, 10.15892028808594],
		[51.11473061746101, 10.171966552734377],
		[51.10309078522957, 10.168533325195312],
		[51.102659624033514, 10.159606933593752],
		[51.083684549980795, 10.144500732421877],
		[51.07505694228799, 10.149307250976564],
		[51.055207338584964, 10.140380859375002],
		[51.05002778118271, 10.163040161132814],
		[51.04182563049972, 10.185699462890627],
		[51.00813842240311, 10.201492309570314],
		[50.99733605932478, 10.182952880859377],
		[50.997768202142076, 10.17814636230469],
		[51.000360974529464, 10.171279907226562],
		[50.99517528486863, 10.15892028808594],
		[51.00511401428095, 10.101928710937502],
		[51.00900250279051, 10.08201599121094],
		[51.0098665670808, 10.06553649902344],
		[51.00900250279051, 10.03257751464844],
		[51.000360974529464, 10.022277832031252],
		[50.99603960672508, 10.022964477539064],
		[50.98739566370402, 10.020217895507812],
		[50.978750110714046, 10.022964477539064],
		[50.97356200609214, 10.033950805664064],
		[50.96577876231212, 10.039443969726564],
		[50.95366890171828, 10.04150390625],
		[50.94588232462147, 10.052490234375002],
		[50.935498192630625, 10.053176879882814],
		[50.937229042349465, 10.022964477539064],
		[50.93809444305038, 10.008544921875002],
		[50.94069054852026, 9.959793090820314],
		[50.92251476618703, 9.957046508789064],
		[50.92554455650557, 9.975585937500002],
		[50.9264101746413, 9.987945556640627],
		[50.913424211321335, 9.972839355468752],
		[50.90649688226162, 9.974212646484377],
		[50.91125953173824, 9.992752075195314],
		[50.90996067566236, 10.028457641601564],
		[50.89610395554359, 10.04150390625],
		[50.887441411132265, 10.051803588867188],
		[50.880943445511775, 10.040130615234377],
		[50.8627443200421, 10.020904541015627],
		[50.8549425194522, 10.027770996093752],
		[50.848440021829276, 10.028457641601564],
		[50.848440021829276, 10.04150390625],
		[50.830661902891116, 10.027770996093752],
		[50.832830328816826, 10.00785827636719],
		[50.82372226295971, 9.962539672851564],
		[50.81504626233523, 9.950866699218752],
		[50.793349208080215, 9.944000244140627],
		[50.7729447893287, 9.934387207031252],
		[50.75253146565695, 9.928894042968752],
		[50.73949702795903, 9.933013916015627],
		[50.69863228887699, 9.910354614257814],
		[50.69515279329137, 9.915847778320314],
		[50.68688795669134, 9.904174804687502],
		[50.6821023857436, 9.88975524902344],
		[50.6677427443026, 9.883575439453127],
		[50.66164944798126, 9.88494873046875],
		[50.649895857737604, 9.88426208496094],
		[50.643800245593596, 9.878082275390627],
		[50.639445752736684, 9.883575439453127],
		[50.63117110465768, 9.894561767578127],
		[50.63421982868815, 9.908294677734377],
		[50.630735556512526, 9.93370056152344],
		[50.62812218290114, 9.946060180664062],
		[50.62855775525792, 9.9591064453125],
		[50.640752142960615, 9.970092773437502],
		[50.65250802085826, 9.95567321777344],
		[50.66600188318191, 9.971466064453127],
		[50.665566657816164, 9.981765747070314],
		[50.67209461471226, 10.000305175781252],
		[50.67340009717013, 10.026397705078127],
		[50.67078909594768, 10.04356384277344],
		[50.665566657816164, 10.053176879882814],
		[50.63988122017964, 10.075836181640625],
		[50.62768660650907, 10.081329345703127],
		[50.61984554139944, 10.068969726562502],
		[50.62333062064346, 10.057983398437502],
		[50.61461743826628, 10.044250488281252],
		[50.592827419653545, 10.053863525390627],
		[50.57538813950031, 10.048370361328127],
		[50.564485309567644, 10.051803588867188],
		[50.55445247756283, 10.064163208007814],
		[50.52870631568803, 10.042877197265627],
		[50.51473641640986, 10.04081726074219],
		[50.52565075356608, 10.067596435546877],
		[50.55270741920067, 10.086822509765627],
		[50.55445247756283, 10.099182128906252],
		[50.56055967312766, 10.119781494140627],
		[50.54747185651962, 10.132141113281252],
		[50.543981158395674, 10.148620605468752],
		[50.55096229623994, 10.199432373046877],
		[50.53874462668945, 10.204925537109377],
		[50.51167994970682, 10.246124267578127],
		[50.50818660259058, 10.26397705078125],
		[50.501199132933344, 10.279083251953127],
		[50.495084248830636, 10.294189453125002],
		[50.49246334187725, 10.309295654296877],
		[50.48984228951737, 10.325775146484377],
		[50.474112921677154, 10.332641601562502],
		[50.463623767993795, 10.332641601562502],
		[50.44176389056172, 10.362854003906252],
		[50.433017111356605, 10.386199951171877],
		[50.40326597175612, 10.386199951171877],
		[50.393636602165074, 10.413665771484377],
		[50.395387542135495, 10.428771972656252],
		[50.39976460914401, 10.447998046875002],
		[50.38663219559585, 10.467224121093752],
		[50.36561276727897, 10.487823486328127],
		[50.35509956048053, 10.491943359375002],
		[50.35509956048053, 10.513916015625002],
		[50.35159464074624, 10.516662597656252],
		[50.36386072785034, 10.537261962890625],
		[50.34370762530209, 10.567474365234377],
		[50.31126946507119, 10.589447021484375],
		[50.30337575356313, 10.594940185546875],
		[50.237543861552275, 10.603179931640625],
		[50.22875939879218, 10.621032714843752],
		[50.22436656050065, 10.636138916015627],
		[50.22875939879218, 10.655364990234377],
		[50.21118561784258, 10.684204101562502],
		[50.203275304148285, 10.721282958984377],
		[50.219973317586145, 10.743255615234375],
		[50.22963791789675, 10.732269287109377],
		[50.241935486043715, 10.736389160156252],
		[50.24896124371442, 10.751495361328125],
		[50.23930055989883, 10.761108398437502],
		[50.24896124371442, 10.800933837890627],
		[50.28933925329178, 11.2554931640625],
		[50.305130024910035, 11.260986328125],
		[50.33494273843299, 11.280212402343752],
		[50.36123254743067, 11.285705566406252],
		[50.41201824668217, 11.288452148437502],
		[50.447011182312195, 11.2554931640625],
		[50.47498691278631, 11.25823974609375],
		[50.48722109174841, 11.31866455078125],
		[50.51342652633956, 11.39556884765625],
		[50.50818660259058, 11.420288085937502],
		[50.44351305245807, 11.461486816406252],
		[50.42251884281916, 11.466979980468752],
		[50.38575657202081, 11.587829589843752],
		[50.396262987870436, 11.71417236328125],
		[50.39451208023374, 11.79656982421875],
		[50.39801383084027, 11.837768554687502],
		[50.40501655606602, 11.900939941406252],
		[50.40501655606602, 11.922912597656252],
		[50.38225391604122, 11.997070312500002],
		[50.352470894936836, 12.005310058593752],
		[50.33494273843299, 12.052001953125002],
		[50.327929664466296, 12.071228027343752],
		[50.31565429419651, 12.1014404296875],
		],{color: 'red', weight: 6}).addTo(map)
	
	<!-- frontline.bindPopup("Frontline") -->
	
	// add situation.json to the map
	L.geoJson(situation, {
        pointToLayer: function (feature, latlng) {
			
		  // create a custom color mode for this object
		  var color = ms.ColorMode(feature.properties.color,feature.properties.color,feature.properties.color,feature.properties.color,feature.properties.color)
		  
          var mysymbol = new ms.Symbol(
            feature.properties.SIDC, {
              uniqueDesignation: feature.properties.name,
			  colorMode: color,
			  outlineWidth: 3
            })
          // Now that we have a symbol we can ask for the echelon and set the symbol size
          mysymbol = mysymbol.setOptions({ size: iconSize[mysymbol.getProperties().echelon] });
		  
		  console.log(feature.properties.name)
		  
          var myicon = L.divIcon({
            className: '',
            html: mysymbol.asSVG(),
            iconAnchor: new L.Point(mysymbol.getAnchor().x, mysymbol.getAnchor().y)
          });

          return L.marker(latlng, { icon: myicon}).bindPopup(feature.properties.fullname);
        }
      }).addTo(map);
	  
// ORBAT CLUSTERING IN MAP #########################################################

function deClutterEvent(){
	for (var id in orbat){
		//Remove all markers
		map.removeLayer(orbat[id].marker)
	}
	var com = highestCommands()
	for(var id in com){
		deClutter(com[id],null)
	}
	//deClutter("",null)
}
function deClutter(command,latlng){
	var distance = 0;
	var idMarker = [];
	for (var id in orbat){
		if(orbat[id].MilSymbol.uniqueDesignation == command){idMarker.push(id);}
		if(orbat[id].MilSymbol.higherFormation == command){
			if(command != "" && latlng != null){
				distance = Math.max(map.options.crs.latLngToPoint(orbat[id].marker.getLatLng(), map.getZoom()).distanceTo(map.options.crs.latLngToPoint(latlng, map.getZoom())),distance);
			}else{
				if(orbat[id].MilSymbol.uniqueDesignation != "")deClutter(orbat[id].MilSymbol.uniqueDesignation,orbat[id].marker.getLatLng());
			}
		}
	}
	var pixeldistance = 60;
	
	//console.log("command:"+command+" name:"+orbat[idMarker].MilSymbol.uniqueDesignation + "   " + distance +"<"+ Math.abs(map.options.crs.pointToLatLng(L.point(pixeldistance, 0),map.getZoom()).lng - map.options.crs.pointToLatLng(L.point(0, 0),map.getZoom()).lng))
	if(	(distance <  pixeldistance ) ){
		//console.log("command:"+command+" name:"+orbat[idMarker].MilSymbol.uniqueDesignation)
		for ( var i in idMarker) {
			orbat[idMarker[i]].marker.addTo(map);
//			console.log(orbat[idMarker[i]].marker.)
		}
	}else{
		for (var id in orbat){
			if(orbat[id].MilSymbol.higherFormation == command && orbat[id].MilSymbol.uniqueDesignation != ""){
			//console.log(orbat[id].MilSymbol.uniqueDesignation)
				deClutter(orbat[id].MilSymbol.uniqueDesignation,orbat[id].marker.getLatLng())
			}
		}
	}
}
</script>

<p id="output"></p>


</body>

</html>